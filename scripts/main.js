function renderModel(e){"use strict";function t(e,t){var r=map.latLngToLayerPoint(new L.LatLng(t,e));this.stream.point(r.x,r.y)}function r(){var t=a.bounds(e),r=t[0],n=t[1];i.attr("width",n[0]-r[0]).attr("height",n[1]-r[1]).style("left",r[0]+"px").style("top",r[1]+"px"),o.attr("transform","translate("+-r[0]+","+-r[1]+")"),l.attr("d",a)}console.log(map);var i=d3.select(map.getPanes().overlayPane).append("svg"),o=i.append("g").attr("class","leaflet-zoom-hide"),n=d3.geo.transform({point:t}),a=d3.geo.path().projection(n),s=d3.scale.linear().range(["#bdd","#57d"]),l=o.selectAll("path").data(_.slice(e.features,8e4,99e3)).enter().append("path").attr("d",a).style("fill",function(e,t){return s(t/1e4)});map.on("viewreset",r),r()}var map;!function(){"use strict";map=L.map("map").setView([51.95,4.15],13),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"siggyf.c74e2e04",accessToken:"pk.eyJ1Ijoic2lnZ3lmIiwiYSI6Il8xOGdYdlEifQ.3-JZpqwUa3hydjAJFXIlMA"}).addTo(map)}(),function(){"use strict";function e(e){function t(t){for(var r=1/(.1+Math.random()),i=2*Math.random()-.5,o=3/(.1+Math.random()),n=0;e>n;n++){var a=(n/e-i)*o;t[n]+=r*Math.exp(-a*a)}}var r,i=[];for(r=0;e>r;++r)i[r]=0;for(r=0;5>r;++r)t(i);return i.map(function(e,t){return{x:t,y:Math.max(0,e)}})}function t(){var t=o(d3.range(r).map(function(){var t=e(i);return t}));d3.selectAll("#profile path").data(t).transition().duration(5e3).attr("d",h)}var r=5,i=200,o=d3.layout.stack(),n=o(d3.range(r).map(function(){return e(i)})),a=300,s=100,l=d3.scale.linear().domain([0,i-1]).range([0,a]),m=d3.scale.linear().domain([1.5*d3.max(n,function(e){return d3.max(e,function(e){return e.y+e.y0})}),0]).range([s,0]),c=d3.scale.linear().range(["#bdd","#57d"]),h=d3.svg.area().x(function(e){return l(e.x)}).y0(function(e){return m(e.y0)}).y1(function(e){return m(e.y+e.y0)}),u=d3.select("#profile").append("svg").attr("preserveAspectRatio","none").attr("viewBox","0 0 "+a+" "+s);u.selectAll("path").data(n).enter().append("path").attr("d",h).style("fill",function(e,t){return c(t/5)}),setInterval(t,5e3)}(),function(){function e(e){this.object=e,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-(1/0),this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25;var t,r,i=this,o=1e-6,n=0,a=0,s=1,l=new THREE.Vector3,m=!1;this.getPolarAngle=function(){return r},this.getAzimuthalAngle=function(){return t},this.rotateLeft=function(e){a-=e},this.rotateUp=function(e){n-=e},this.panLeft=function(){var e=new THREE.Vector3;return function(t){var r=this.object.matrix.elements;e.set(r[0],r[1],r[2]),e.multiplyScalar(-t),l.add(e)}}(),this.panUp=function(){var e=new THREE.Vector3;return function(t){var r=this.object.matrix.elements;e.set(r[4],r[5],r[6]),e.multiplyScalar(t),l.add(e)}}(),this.pan=function(e,t,r,o){if(i.object instanceof THREE.PerspectiveCamera){var n=i.object.position,a=n.clone().sub(i.target),s=a.length();s*=Math.tan(i.object.fov/2*Math.PI/180),i.panLeft(2*e*s/o),i.panUp(2*t*s/o)}else i.object instanceof THREE.OrthographicCamera?(i.panLeft(e*(i.object.right-i.object.left)/r),i.panUp(t*(i.object.top-i.object.bottom)/o)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){i.object instanceof THREE.PerspectiveCamera?s/=e:i.object instanceof THREE.OrthographicCamera?(i.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom*e)),i.object.updateProjectionMatrix(),m=!0):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.dollyOut=function(e){i.object instanceof THREE.PerspectiveCamera?s*=e:i.object instanceof THREE.OrthographicCamera?(i.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/e)),i.object.updateProjectionMatrix(),m=!0):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.update=function(){var i=new THREE.Vector3,c=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),h=c.clone().inverse(),u=new THREE.Vector3,d=new THREE.Quaternion;return function(){var e=this.object.position;i.copy(e).sub(this.target),i.applyQuaternion(c),t=Math.atan2(i.x,i.z),r=Math.atan2(Math.sqrt(i.x*i.x+i.z*i.z),i.y),t+=a,r+=n,t=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,t)),r=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,r)),r=Math.max(o,Math.min(Math.PI-o,r));var p=i.length()*s;return p=Math.max(this.minDistance,Math.min(this.maxDistance,p)),this.target.add(l),i.x=p*Math.sin(r)*Math.sin(t),i.y=p*Math.cos(r),i.z=p*Math.sin(r)*Math.cos(t),i.applyQuaternion(h),e.copy(this.target).add(i),this.object.lookAt(this.target),this.enableDamping===!0?(a*=1-this.dampingFactor,n*=1-this.dampingFactor):(a=0,n=0),s=1,l.set(0,0,0),m||u.distanceToSquared(this.object.position)>o||8*(1-d.dot(this.object.quaternion))>o?(u.copy(this.object.position),d.copy(this.object.quaternion),m=!1,!0):!1}}()}THREE.OrbitControls=function(t,r){function i(e,t){var r=f.domElement===document?f.domElement.body:f.domElement;E.pan(e,t,r.clientWidth,r.clientHeight)}function o(){return 2*Math.PI/60/60*f.autoRotateSpeed}function n(){return Math.pow(.95,f.zoomSpeed)}function a(e){if(f.enabled!==!1){if(e.preventDefault(),e.button===f.mouseButtons.ORBIT){if(f.enableRotate===!1)return;P=M.ROTATE,v.set(e.clientX,e.clientY)}else if(e.button===f.mouseButtons.ZOOM){if(f.enableZoom===!1)return;P=M.DOLLY,y.set(e.clientX,e.clientY)}else if(e.button===f.mouseButtons.PAN){if(f.enablePan===!1)return;P=M.PAN,T.set(e.clientX,e.clientY)}P!==M.NONE&&(document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",l,!1),f.dispatchEvent(S))}}function s(e){if(f.enabled!==!1){e.preventDefault();var t=f.domElement===document?f.domElement.body:f.domElement;if(P===M.ROTATE){if(f.enableRotate===!1)return;x.set(e.clientX,e.clientY),g.subVectors(x,v),E.rotateLeft(2*Math.PI*g.x/t.clientWidth*f.rotateSpeed),E.rotateUp(2*Math.PI*g.y/t.clientHeight*f.rotateSpeed),v.copy(x)}else if(P===M.DOLLY){if(f.enableZoom===!1)return;w.set(e.clientX,e.clientY),H.subVectors(w,y),H.y>0?E.dollyIn(n()):H.y<0&&E.dollyOut(n()),y.copy(w)}else if(P===M.PAN){if(f.enablePan===!1)return;b.set(e.clientX,e.clientY),R.subVectors(b,T),i(R.x,R.y),T.copy(b)}P!==M.NONE&&f.update()}}function l(){f.enabled!==!1&&(document.removeEventListener("mousemove",s,!1),document.removeEventListener("mouseup",l,!1),f.dispatchEvent(O),P=M.NONE)}function m(e){if(f.enabled!==!1&&f.enableZoom!==!1&&P===M.NONE){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?E.dollyOut(n()):0>t&&E.dollyIn(n()),f.update(),f.dispatchEvent(S),f.dispatchEvent(O)}}function c(e){if(f.enabled!==!1&&f.enableKeys!==!1&&f.enablePan!==!1)switch(e.keyCode){case f.keys.UP:i(0,f.keyPanSpeed),f.update();break;case f.keys.BOTTOM:i(0,-f.keyPanSpeed),f.update();break;case f.keys.LEFT:i(f.keyPanSpeed,0),f.update();break;case f.keys.RIGHT:i(-f.keyPanSpeed,0),f.update()}}function h(e){if(f.enabled!==!1){switch(e.touches.length){case 1:if(f.enableRotate===!1)return;P=M.TOUCH_ROTATE,v.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(f.enableZoom===!1)return;P=M.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+r*r);y.set(0,i);break;case 3:if(f.enablePan===!1)return;P=M.TOUCH_PAN,T.set(e.touches[0].pageX,e.touches[0].pageY);break;default:P=M.NONE}P!==M.NONE&&f.dispatchEvent(S)}}function u(e){if(f.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=f.domElement===document?f.domElement.body:f.domElement;switch(e.touches.length){case 1:if(f.enableRotate===!1)return;if(P!==M.TOUCH_ROTATE)return;x.set(e.touches[0].pageX,e.touches[0].pageY),g.subVectors(x,v),E.rotateLeft(2*Math.PI*g.x/t.clientWidth*f.rotateSpeed),E.rotateUp(2*Math.PI*g.y/t.clientHeight*f.rotateSpeed),v.copy(x),f.update();break;case 2:if(f.enableZoom===!1)return;if(P!==M.TOUCH_DOLLY)return;var r=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(r*r+o*o);w.set(0,a),H.subVectors(w,y),H.y>0?E.dollyOut(n()):H.y<0&&E.dollyIn(n()),y.copy(w),f.update();break;case 3:if(f.enablePan===!1)return;if(P!==M.TOUCH_PAN)return;b.set(e.touches[0].pageX,e.touches[0].pageY),R.subVectors(b,T),i(R.x,R.y),T.copy(b),f.update();break;default:P=M.NONE}}}function d(){f.enabled!==!1&&(f.dispatchEvent(O),P=M.NONE)}function p(e){e.preventDefault()}var E=new e(t);this.domElement=void 0!==r?r:document,Object.defineProperty(this,"constraint",{get:function(){return E}}),this.getPolarAngle=function(){return E.getPolarAngle()},this.getAzimuthalAngle=function(){return E.getAzimuthalAngle()},this.enabled=!0,this.center=this.target,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var f=this,v=new THREE.Vector2,x=new THREE.Vector2,g=new THREE.Vector2,T=new THREE.Vector2,b=new THREE.Vector2,R=new THREE.Vector2,y=new THREE.Vector2,w=new THREE.Vector2,H=new THREE.Vector2,M={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},P=M.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom;var C={type:"change"},S={type:"start"},O={type:"end"};this.update=function(){this.autoRotate&&P===M.NONE&&E.rotateLeft(o()),E.update()===!0&&this.dispatchEvent(C)},this.reset=function(){P=M.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(C),this.update()},this.dispose=function(){this.domElement.removeEventListener("contextmenu",p,!1),this.domElement.removeEventListener("mousedown",a,!1),this.domElement.removeEventListener("mousewheel",m,!1),this.domElement.removeEventListener("MozMousePixelScroll",m,!1),this.domElement.removeEventListener("touchstart",h,!1),this.domElement.removeEventListener("touchend",d,!1),this.domElement.removeEventListener("touchmove",u,!1),document.removeEventListener("mousemove",s,!1),document.removeEventListener("mouseup",l,!1),window.removeEventListener("keydown",c,!1)},this.domElement.addEventListener("contextmenu",p,!1),this.domElement.addEventListener("mousedown",a,!1),this.domElement.addEventListener("mousewheel",m,!1),this.domElement.addEventListener("MozMousePixelScroll",m,!1),this.domElement.addEventListener("touchstart",h,!1),this.domElement.addEventListener("touchend",d,!1),this.domElement.addEventListener("touchmove",u,!1),window.addEventListener("keydown",c,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{object:{get:function(){return this.constraint.object}},target:{get:function(){return this.constraint.target},set:function(e){console.warn("THREE.OrbitControls: target is now immutable. Use target.set() instead."),this.constraint.target.copy(e)}},minDistance:{get:function(){return this.constraint.minDistance},set:function(e){this.constraint.minDistance=e}},maxDistance:{get:function(){return this.constraint.maxDistance},set:function(e){this.constraint.maxDistance=e}},minZoom:{get:function(){return this.constraint.minZoom},set:function(e){this.constraint.minZoom=e}},maxZoom:{get:function(){return this.constraint.maxZoom},set:function(e){this.constraint.maxZoom=e}},minPolarAngle:{get:function(){return this.constraint.minPolarAngle},set:function(e){this.constraint.minPolarAngle=e}},maxPolarAngle:{get:function(){return this.constraint.maxPolarAngle},set:function(e){this.constraint.maxPolarAngle=e}},minAzimuthAngle:{get:function(){return this.constraint.minAzimuthAngle},set:function(e){this.constraint.minAzimuthAngle=e}},maxAzimuthAngle:{get:function(){return this.constraint.maxAzimuthAngle},set:function(e){this.constraint.maxAzimuthAngle=e}},enableDamping:{get:function(){return this.constraint.enableDamping},set:function(e){this.constraint.enableDamping=e}},dampingFactor:{get:function(){return this.constraint.dampingFactor},set:function(e){this.constraint.dampingFactor=e}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.constraint.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.constraint.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.constraint.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.constraint.dampingFactor=e}}})}(),THREE.ShaderLib.mirror={uniforms:{mirrorColor:{type:"c",value:new THREE.Color(8355711)},mirrorSampler:{type:"t",value:null},textureMatrix:{type:"m4",value:new THREE.Matrix4}},vertexShader:["uniform mat4 textureMatrix;","varying vec4 mirrorCoord;","void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","mirrorCoord = textureMatrix * worldPosition;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 mirrorColor;","uniform sampler2D mirrorSampler;","varying vec4 mirrorCoord;","float blendOverlay(float base, float blend) {","return( base < 0.5 ? ( 2.0 * base * blend ) : (1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );","}","void main() {","vec4 color = texture2DProj(mirrorSampler, mirrorCoord);","color = vec4(blendOverlay(mirrorColor.r, color.r), blendOverlay(mirrorColor.g, color.g), blendOverlay(mirrorColor.b, color.b), 1.0);","gl_FragColor = color;","}"].join("\n")},THREE.Mirror=function(e,t,r){THREE.Object3D.call(this),this.name="mirror_"+this.id,r=r||{},this.matrixNeedsUpdate=!0;var i=void 0!==r.textureWidth?r.textureWidth:512,o=void 0!==r.textureHeight?r.textureHeight:512;this.clipBias=void 0!==r.clipBias?r.clipBias:0;var n=void 0!==r.color?new THREE.Color(r.color):new THREE.Color(8355711);this.renderer=e,this.mirrorPlane=new THREE.Plane,this.normal=new THREE.Vector3(0,0,1),this.mirrorWorldPosition=new THREE.Vector3,this.cameraWorldPosition=new THREE.Vector3,this.rotationMatrix=new THREE.Matrix4,this.lookAtPosition=new THREE.Vector3(0,0,-1),this.clipPlane=new THREE.Vector4;var a=void 0!==r.debugMode?r.debugMode:!1;if(a){var s=new THREE.ArrowHelper(new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,0),10,16777088),l=new THREE.Geometry;l.vertices.push(new THREE.Vector3(-10,-10,0)),l.vertices.push(new THREE.Vector3(10,-10,0)),l.vertices.push(new THREE.Vector3(10,10,0)),l.vertices.push(new THREE.Vector3(-10,10,0)),l.vertices.push(l.vertices[0]);var m=new THREE.Line(l,new THREE.LineBasicMaterial({color:16777088}));this.add(s),this.add(m)}t instanceof THREE.PerspectiveCamera?this.camera=t:(this.camera=new THREE.PerspectiveCamera,console.log(this.name+": camera is not a Perspective Camera!")),this.textureMatrix=new THREE.Matrix4,this.mirrorCamera=this.camera.clone(),this.mirrorCamera.matrixAutoUpdate=!0;var c={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1};this.texture=new THREE.WebGLRenderTarget(i,o,c),this.tempTexture=new THREE.WebGLRenderTarget(i,o,c);var h=THREE.ShaderLib.mirror,u=THREE.UniformsUtils.clone(h.uniforms);this.material=new THREE.ShaderMaterial({fragmentShader:h.fragmentShader,vertexShader:h.vertexShader,uniforms:u}),this.material.uniforms.mirrorSampler.value=this.texture,this.material.uniforms.mirrorColor.value=n,this.material.uniforms.textureMatrix.value=this.textureMatrix,THREE.Math.isPowerOfTwo(i)&&THREE.Math.isPowerOfTwo(o)||(this.texture.generateMipmaps=!1,this.tempTexture.generateMipmaps=!1),this.updateTextureMatrix(),this.render()},THREE.Mirror.prototype=Object.create(THREE.Object3D.prototype),THREE.Mirror.prototype.constructor=THREE.Mirror,THREE.Mirror.prototype.renderWithMirror=function(e){this.updateTextureMatrix(),this.matrixNeedsUpdate=!1;var t=e.camera;e.camera=this.mirrorCamera,e.renderTemp(),e.material.uniforms.mirrorSampler.value=e.tempTexture,this.render(),this.matrixNeedsUpdate=!0,e.material.uniforms.mirrorSampler.value=e.texture,e.camera=t,e.updateTextureMatrix()},THREE.Mirror.prototype.updateTextureMatrix=function(){this.updateMatrixWorld(),this.camera.updateMatrixWorld(),this.mirrorWorldPosition.setFromMatrixPosition(this.matrixWorld),this.cameraWorldPosition.setFromMatrixPosition(this.camera.matrixWorld),this.rotationMatrix.extractRotation(this.matrixWorld),this.normal.set(0,0,1),this.normal.applyMatrix4(this.rotationMatrix);var e=this.mirrorWorldPosition.clone().sub(this.cameraWorldPosition);e.reflect(this.normal).negate(),e.add(this.mirrorWorldPosition),this.rotationMatrix.extractRotation(this.camera.matrixWorld),this.lookAtPosition.set(0,0,-1),this.lookAtPosition.applyMatrix4(this.rotationMatrix),this.lookAtPosition.add(this.cameraWorldPosition);var t=this.mirrorWorldPosition.clone().sub(this.lookAtPosition);t.reflect(this.normal).negate(),t.add(this.mirrorWorldPosition),this.up.set(0,-1,0),this.up.applyMatrix4(this.rotationMatrix),this.up.reflect(this.normal).negate(),this.mirrorCamera.position.copy(e),this.mirrorCamera.up=this.up,this.mirrorCamera.lookAt(t),this.mirrorCamera.updateProjectionMatrix(),this.mirrorCamera.updateMatrixWorld(),this.mirrorCamera.matrixWorldInverse.getInverse(this.mirrorCamera.matrixWorld),this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.mirrorCamera.projectionMatrix),this.textureMatrix.multiply(this.mirrorCamera.matrixWorldInverse),this.mirrorPlane.setFromNormalAndCoplanarPoint(this.normal,this.mirrorWorldPosition),this.mirrorPlane.applyMatrix4(this.mirrorCamera.matrixWorldInverse),this.clipPlane.set(this.mirrorPlane.normal.x,this.mirrorPlane.normal.y,this.mirrorPlane.normal.z,this.mirrorPlane.constant);var r=new THREE.Vector4,i=this.mirrorCamera.projectionMatrix;r.x=(Math.sign(this.clipPlane.x)+i.elements[8])/i.elements[0],r.y=(Math.sign(this.clipPlane.y)+i.elements[9])/i.elements[5],r.z=-1,r.w=(1+i.elements[10])/i.elements[14];var o=new THREE.Vector4;o=this.clipPlane.multiplyScalar(2/this.clipPlane.dot(r)),i.elements[2]=o.x,i.elements[6]=o.y,i.elements[10]=o.z+1-this.clipBias,i.elements[14]=o.w},THREE.Mirror.prototype.render=function(){this.matrixNeedsUpdate&&this.updateTextureMatrix(),this.matrixNeedsUpdate=!0;for(var e=this;null!==e.parent;)e=e.parent;if(void 0!==e&&e instanceof THREE.Scene){var t=this.material.visible;this.material.visible=!1,this.renderer.render(e,this.mirrorCamera,this.texture,!0),this.material.visible=t}},THREE.Mirror.prototype.renderTemp=function(){this.matrixNeedsUpdate&&this.updateTextureMatrix(),this.matrixNeedsUpdate=!0;for(var e=this;null!==e.parent;)e=e.parent;void 0!==e&&e instanceof THREE.Scene&&this.renderer.render(e,this.mirrorCamera,this.tempTexture,!0)},THREE.ShaderLib.water={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.fog,{normalSampler:{type:"t",value:null},mirrorSampler:{type:"t",value:null},alpha:{type:"f",value:1},time:{type:"f",value:0},distortionScale:{type:"f",value:20},noiseScale:{type:"f",value:1},textureMatrix:{type:"m4",value:new THREE.Matrix4},sunColor:{type:"c",value:new THREE.Color(8355711)},sunDirection:{type:"v3",value:new THREE.Vector3(.70707,.70707,0)},eye:{type:"v3",value:new THREE.Vector3(0,0,0)},waterColor:{type:"c",value:new THREE.Color(5592405)}}]),vertexShader:["uniform mat4 textureMatrix;","uniform float time;","varying vec4 mirrorCoord;","varying vec3 worldPosition;","void main()","{","	mirrorCoord = modelMatrix * vec4( position, 1.0 );","	worldPosition = mirrorCoord.xyz;","	mirrorCoord = textureMatrix * mirrorCoord;","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D mirrorSampler;","uniform float alpha;","uniform float time;","uniform float distortionScale;","uniform sampler2D normalSampler;","uniform vec3 sunColor;","uniform vec3 sunDirection;","uniform vec3 eye;","uniform vec3 waterColor;","varying vec4 mirrorCoord;","varying vec3 worldPosition;","vec4 getNoise( vec2 uv )","{","	vec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);","	vec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );","	vec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );","	vec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );","	vec4 noise = ( texture2D( normalSampler, uv0 ) ) +","		( texture2D( normalSampler, uv1 ) ) +","		( texture2D( normalSampler, uv2 ) ) +","		( texture2D( normalSampler, uv3 ) );","	return noise * 0.5 - 1.0;","}","void sunLight( const vec3 surfaceNormal, const vec3 eyeDirection, float shiny, float spec, float diffuse, inout vec3 diffuseColor, inout vec3 specularColor )","{","	vec3 reflection = normalize( reflect( -sunDirection, surfaceNormal ) );","	float direction = max( 0.0, dot( eyeDirection, reflection ) );","	specularColor += pow( direction, shiny ) * sunColor * spec;","	diffuseColor += max( dot( sunDirection, surfaceNormal ), 0.0 ) * sunColor * diffuse;","}",THREE.ShaderChunk.common,THREE.ShaderChunk.fog_pars_fragment,"void main()","{","	vec4 noise = getNoise( worldPosition.xz );","	vec3 surfaceNormal = normalize( noise.xzy * vec3( 1.5, 1.0, 1.5 ) );","	vec3 diffuseLight = vec3(0.0);","	vec3 specularLight = vec3(0.0);","	vec3 worldToEye = eye-worldPosition;","	vec3 eyeDirection = normalize( worldToEye );","	sunLight( surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight );","	float distance = length(worldToEye);","	vec2 distortion = surfaceNormal.xz * ( 0.001 + 1.0 / distance ) * distortionScale;","	vec3 reflectionSample = vec3( texture2D( mirrorSampler, mirrorCoord.xy / mirrorCoord.z + distortion ) );","	float theta = max( dot( eyeDirection, surfaceNormal ), 0.0 );","	float rf0 = 0.3;","	float reflectance = rf0 + ( 1.0 - rf0 ) * pow( ( 1.0 - theta ), 5.0 );","	vec3 scatter = max( 0.0, dot( surfaceNormal, eyeDirection ) ) * waterColor;","	vec3 albedo = mix( sunColor * diffuseLight * 0.3 + scatter, ( vec3( 0.1 ) + reflectionSample * 0.9 + reflectionSample * specularLight ), reflectance );","	vec3 outgoingLight = albedo;",THREE.ShaderChunk.fog_fragment,"	gl_FragColor = vec4( outgoingLight, alpha );","}"].join("\n")},THREE.Water=function(e,t,r,i){function o(e,t){return void 0!==e?e:t}THREE.Object3D.call(this),this.name="water_"+this.id,i=i||{},this.matrixNeedsUpdate=!0;var n=o(i.textureWidth,512),a=o(i.textureHeight,512);this.clipBias=o(i.clipBias,0),this.alpha=o(i.alpha,1),this.time=o(i.time,0),this.normalSampler=o(i.waterNormals,null),this.sunDirection=o(i.sunDirection,new THREE.Vector3(.70707,.70707,0)),this.sunColor=new THREE.Color(o(i.sunColor,16777215)),this.waterColor=new THREE.Color(o(i.waterColor,8355711)),this.eye=o(i.eye,new THREE.Vector3(0,0,0)),this.distortionScale=o(i.distortionScale,20),this.side=o(i.side,THREE.FrontSide),this.fog=o(i.fog,!1),this.renderer=e,this.scene=r,this.mirrorPlane=new THREE.Plane,this.normal=new THREE.Vector3(0,0,1),this.mirrorWorldPosition=new THREE.Vector3,this.cameraWorldPosition=new THREE.Vector3,this.rotationMatrix=new THREE.Matrix4,this.lookAtPosition=new THREE.Vector3(0,0,-1),this.clipPlane=new THREE.Vector4,t instanceof THREE.PerspectiveCamera?this.camera=t:(this.camera=new THREE.PerspectiveCamera,console.log(this.name+": camera is not a Perspective Camera!")),this.textureMatrix=new THREE.Matrix4,this.mirrorCamera=this.camera.clone(),this.texture=new THREE.WebGLRenderTarget(n,a),this.tempTexture=new THREE.WebGLRenderTarget(n,a);var s=THREE.ShaderLib.water,l=THREE.UniformsUtils.clone(s.uniforms);this.material=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:l,transparent:!0,side:this.side,fog:this.fog}),this.material.uniforms.mirrorSampler.value=this.texture,this.material.uniforms.textureMatrix.value=this.textureMatrix,this.material.uniforms.alpha.value=this.alpha,this.material.uniforms.time.value=this.time,this.material.uniforms.normalSampler.value=this.normalSampler,this.material.uniforms.sunColor.value=this.sunColor,this.material.uniforms.waterColor.value=this.waterColor,this.material.uniforms.sunDirection.value=this.sunDirection,this.material.uniforms.distortionScale.value=this.distortionScale,this.material.uniforms.eye.value=this.eye,THREE.Math.isPowerOfTwo(n)&&THREE.Math.isPowerOfTwo(a)||(this.texture.generateMipmaps=!1,this.texture.minFilter=THREE.LinearFilter,this.tempTexture.generateMipmaps=!1,this.tempTexture.minFilter=THREE.LinearFilter),this.updateTextureMatrix(),this.render()},THREE.Water.prototype=Object.create(THREE.Mirror.prototype),THREE.Water.prototype.constructor=THREE.Water,THREE.Water.prototype.updateTextureMatrix=function(){function e(e){return e?0>e?-1:1:0}this.updateMatrixWorld(),this.camera.updateMatrixWorld(),this.mirrorWorldPosition.setFromMatrixPosition(this.matrixWorld),this.cameraWorldPosition.setFromMatrixPosition(this.camera.matrixWorld),this.rotationMatrix.extractRotation(this.matrixWorld),this.normal.set(0,0,1),this.normal.applyMatrix4(this.rotationMatrix);var t=this.mirrorWorldPosition.clone().sub(this.cameraWorldPosition);t.reflect(this.normal).negate(),t.add(this.mirrorWorldPosition),this.rotationMatrix.extractRotation(this.camera.matrixWorld),this.lookAtPosition.set(0,0,-1),this.lookAtPosition.applyMatrix4(this.rotationMatrix),this.lookAtPosition.add(this.cameraWorldPosition);var r=this.mirrorWorldPosition.clone().sub(this.lookAtPosition);r.reflect(this.normal).negate(),r.add(this.mirrorWorldPosition),this.up.set(0,-1,0),this.up.applyMatrix4(this.rotationMatrix),this.up.reflect(this.normal).negate(),this.mirrorCamera.position.copy(t),this.mirrorCamera.up=this.up,this.mirrorCamera.lookAt(r),this.mirrorCamera.aspect=this.camera.aspect,this.mirrorCamera.updateProjectionMatrix(),this.mirrorCamera.updateMatrixWorld(),this.mirrorCamera.matrixWorldInverse.getInverse(this.mirrorCamera.matrixWorld),this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.mirrorCamera.projectionMatrix),this.textureMatrix.multiply(this.mirrorCamera.matrixWorldInverse),this.mirrorPlane.setFromNormalAndCoplanarPoint(this.normal,this.mirrorWorldPosition),this.mirrorPlane.applyMatrix4(this.mirrorCamera.matrixWorldInverse),this.clipPlane.set(this.mirrorPlane.normal.x,this.mirrorPlane.normal.y,this.mirrorPlane.normal.z,this.mirrorPlane.constant);var i=new THREE.Vector4,o=this.mirrorCamera.projectionMatrix;i.x=(e(this.clipPlane.x)+o.elements[8])/o.elements[0],i.y=(e(this.clipPlane.y)+o.elements[9])/o.elements[5],i.z=-1,i.w=(1+o.elements[10])/o.elements[14];var n=new THREE.Vector4;n=this.clipPlane.multiplyScalar(2/this.clipPlane.dot(i)),o.elements[2]=n.x,o.elements[6]=n.y,o.elements[10]=n.z+1-this.clipBias,o.elements[14]=n.w;var a=new THREE.Vector3;a.setFromMatrixPosition(this.camera.matrixWorld),this.eye=a,this.material.uniforms.eye.value=this.eye},function(){"use strict";function e(){i=$("#threed")[0],a=new THREE.WebGLRenderer,a.setPixelRatio(window.devicePixelRatio),a.setSize(i.clientWidth,i.clientHeight),i.appendChild(a.domElement),n=new THREE.Scene,o=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.5,3e6),o.position.set(2e3,750,2e3),l=new THREE.OrbitControls(o,a.domElement),l.enablePan=!1,l.minDistance=5e3,l.maxDistance=5e3,l.minPolarAngle=.45*Math.PI,l.maxPolarAngle=.45*Math.PI,l.minAzimuthAngle=-.1*Math.PI,l.maxAzimuthAngle=.1*Math.PI,l.center.set(0,500,0),n.add(new THREE.AmbientLight(4473924));var e=new THREE.DirectionalLight(16777147,1);e.position.set(-1,1,-1),n.add(e),m=new THREE.ImageUtils.loadTexture("textures/waternormals.jpg"),m.wrapS=m.wrapT=THREE.RepeatWrapping,s=new THREE.Water(a,o,n,{textureWidth:512,textureHeight:512,waterNormals:m,alpha:1,sunDirection:e.position.clone().normalize(),sunColor:16777215,waterColor:7695,distortionScale:50});var t=new THREE.Mesh(new THREE.PlaneBufferGeometry(500*c.width,500*c.height),s.material);t.add(s),t.rotation.x=.5*-Math.PI,n.add(t);var r=new THREE.CubeTexture([]);r.format=THREE.RGBFormat;var h=new THREE.ImageLoader;h.load("textures/skyboxsun25degtest.png",function(e){var t=function(t,r){var i=1024,o=document.createElement("canvas");o.width=i,o.height=i;var n=o.getContext("2d");return n.drawImage(e,-t*i,-r*i),o};r.images[0]=t(2,1),r.images[1]=t(0,1),r.images[2]=t(1,0),r.images[3]=t(1,2),r.images[4]=t(1,1),r.images[5]=t(3,1),r.needsUpdate=!0});var u=THREE.ShaderLib.cube;u.uniforms.tCube.value=r;var d=new THREE.ShaderMaterial({fragmentShader:u.fragmentShader,vertexShader:u.vertexShader,uniforms:u.uniforms,depthWrite:!1,side:THREE.BackSide}),p=new THREE.Mesh(new THREE.BoxGeometry(1e6,1e6,1e6),d);n.add(p)}function t(){requestAnimationFrame(t),r()}function r(){.001*performance.now();a.setSize(i.clientWidth,i.clientHeight),s.material.uniforms.time.value+=1/60,l.update(),s.render(),a.render(n,o)}var i,o,n,a,s,l,m,c={width:2e3,height:2e3,widthSegments:250,heightSegments:250,depth:1500,param:4,filterparam:1};e(),t()}(),function(){"use strict";fetch("models/grid.json").then(function(e){return e.json()}).then(function(e){console.log(e),renderModel(e)})}();